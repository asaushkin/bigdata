#!/bin/bash

set -x

PROJECT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"
AWS_CLI=$(which aws)

STACK_NAME=bigdata-udemy
REGION_NAME=us-west-2
S3_RESOURCE_BUCKET=autogenerated-artifacts
S3_RESOURCE_PREFIX=bigdata-udemy/v1.0.0

if [[ $? != 0 ]]; then
    echo "AWS CLI not found. Exiting."
    exit 1
fi

${AWS_CLI} cloudformation package  \
    --template-file ${PROJECT_DIR}/template.yaml \
    --s3-bucket $S3_RESOURCE_BUCKET \
    --s3-prefix $S3_RESOURCE_PREFIX \
    --output-template-file ${PROJECT_DIR}/autogenerated.yaml

${AWS_CLI} s3 cp ${PROJECT_DIR}/autogenerated.yaml \
    s3://$S3_RESOURCE_BUCKET/$S3_RESOURCE_PREFIX/stack.template

${AWS_CLI} --region $REGION_NAME cloudformation deploy \
    --s3-bucket $S3_RESOURCE_BUCKET \
    --s3-prefix $S3_RESOURCE_PREFIX \
    --template-file ${PROJECT_DIR}/autogenerated.yaml \
    --capabilities CAPABILITY_IAM CAPABILITY_AUTO_EXPAND \
    --stack-name $STACK_NAME
